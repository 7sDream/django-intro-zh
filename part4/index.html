<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <meta name="author" content="7sDream">
        <link rel="canonical" href="http://django-intro-zh.readthedocs.org/part4/">
        <link rel="shortcut icon" href="../img/favicon.ico">

	<title>第一个 Django 项目 - 第四部分 - Django intro 中文版</title>

        <link href="../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../css/font-awesome-4.0.3.css" rel="stylesheet">
        <link rel="stylesheet" href="../css/highlight.css">
        <link href="../css/base.css" rel="stylesheet">

        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->

        
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>

            <!-- Main title -->
            <a class="navbar-brand" href="..">Django intro 中文版</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
            <!-- Main navigation -->
            <ul class="nav navbar-nav">
            
            
                <li >
                    <a href="..">介绍</a>
                </li>
            
            
            
                <li class="dropdown active">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">文档 <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                    
                        <li >
                            <a href="../glance/">初识 Django</a>
                        </li>
                    
                        <li >
                            <a href="../install/">快速安装指南</a>
                        </li>
                    
                        <li >
                            <a href="../part1/">第一个 Django 项目 - 第一部分</a>
                        </li>
                    
                        <li >
                            <a href="../part2/">第一个 Django 项目 - 第二部分</a>
                        </li>
                    
                        <li >
                            <a href="../part3/">第一个 Django 项目 - 第三部分</a>
                        </li>
                    
                        <li class="active">
                            <a href="./">第一个 Django 项目 - 第四部分</a>
                        </li>
                    
                        <li >
                            <a href="../part5/">第一个 Django 项目 - 第五部分</a>
                        </li>
                    
                        <li >
                            <a href="../part6/">第一个 Django 项目 - 第六部分</a>
                        </li>
                    
                        <li >
                            <a href="../whats_next/">下一步我该干什么</a>
                        </li>
                    
                        <li >
                            <a href="../reusable_app/">编写可重用的应用</a>
                        </li>
                    
                        <li >
                            <a href="../patch/">为 Django 贡献代码</a>
                        </li>
                    
                    </ul>
                </li>
            
            
            </ul>

            <!-- Search, Navigation and Repo links -->
            <ul class="nav navbar-nav navbar-right">
                <li >
                    <a rel="next" href="../part3/">
                        <i class="fa fa-arrow-left"></i> Previous
                    </a>
                </li>
                <li >
                    <a rel="prev" href="../part5/">
                        Next <i class="fa fa-arrow-right"></i>
                    </a>
                </li>
                
                <li>
                    <a href="https://github.com/7sDream/django-intro-zh">
                        
                        django-intro-zh
                    </a>
                </li>
                
            </ul>
        </div>
    </div>
</div>

        <div class="container">
            <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
    
        <li class="main active"><a href="#django">创建你的第一个 Django 项目， 第四部分</a></li>
        
            <li><a href="#_1">编写一个简单的表单</a></li>
        
            <li><a href="#_2">使用通用视图：代码还是少点好</a></li>
        
    
    </ul>
</div></div>
            <div class="col-md-9" role="main">

<h1 id="django">创建你的第一个 Django 项目， 第四部分</h1>
<p>这一篇从<a href="../part3/">第三部分（zh）</a>结尾的地方继续讲起。我们将继续编写投票应用，专注于简单的表单处理并且精简我们的代码。</p>
<h2 id="_1">编写一个简单的表单</h2>
<p>让我们更新一下在上一个教程中编写的投票详细页面的模板（“polls/detail.html”），让它包含一个 HTML  &lt;<strong>form</strong>&gt;元素：</p>
<pre><code class="html">&lt;!--- polls/template/polls/detail.html --&gt;

&lt;h1&gt;{{ question.question_text }}&lt;/h1&gt;

{% if error_message %}&lt;p&gt;&lt;strong&gt;{{ error_message }}&lt;/strong&gt;&lt;/p&gt;{% endif %}

&lt;form action=&quot;{% url 'polls:vote' question.id %}&quot; method=&quot;post&quot;&gt;
{% csrf_token %}
{% for choice in question.choice_set.all %}
    &lt;input type=&quot;radio&quot; name=&quot;choice&quot; id=&quot;choice{{ forloop.counter }}&quot; value=&quot;{{ choice.id }}&quot; /&gt;
    &lt;label for=&quot;choice{{ forloop.counter }}&quot;&gt;{{ choice.choice_text }}&lt;/label&gt;&lt;br /&gt;
{% endfor %}
&lt;input type=&quot;submit&quot; value=&quot;Vote&quot; /&gt;
&lt;/form&gt;
</code></pre>

<p>简要说明：</p>
<ul>
<li>上面的模板在 Question 的每个 Choice 前添加一个单选按钮。 每个单选按钮的 <strong>value</strong> 属性是对应的各个 Choice 的 ID。每个单选按钮的 <strong>name</strong> 是 <strong>"choice"</strong>。这意味着，当有人选择一个单选按钮并提交表单提交时，它将发送一个 POST 数据 choice=#，其中# 为选择的 Choice 的 ID。这是 HTML 表单的基本概念。</li>
<li>我们设置表单的 <strong>action</strong> 为 <strong>{% url 'polls:vote' question.id %}</strong>，并设置   <strong>method="post"</strong>。使用 <strong>method="post"</strong>（与其相对的是<strong>method="get"</strong>）是非常重要的，因为这个提交表单的行为会改变服务器端的数据。 无论何时，当你需要创建一个改变服务器端数据的表单时，请使用 <strong>method="post"</strong>。这不是 Django 的特定技巧；这是优秀的网站开发实践。</li>
<li><strong>forloop.counter</strong> 指示 <a href="https://docs.djangoproject.com/en/1.8/ref/templates/builtins/#std:templatetag-for"><strong>for</strong></a> 标签已经循环多少次。</li>
<li>由于我们创建一个 POST 表单（它具有修改数据的作用），所以我们需要小心跨站点请求伪造。 谢天谢地，你不必太过担心，因为 Django 已经拥有一个用来防御它的非常容易使用的系统。 简而言之，所有针对内部 URL 的 POST 表单都应该使用 <a href="https://docs.djangoproject.com/en/1.8/ref/templates/builtins/#std:templatetag-csrf_token"><strong>{%csrf_token %}</strong></a> 模板标签。</li>
</ul>
<p>现在，让我们来创建一个 Django 视图来处理提交的数据。记住，在教程<a href="../part3/">第三部分（zh）</a>中，我们为投票应用创建了一个 URLconf ，包含这一行：</p>
<pre><code class="python"># polls/urls.py

url(r'^(?P&lt;question_id&gt;[0-9]+)/vote/$', views.vote, name='vote'),
</code></pre>

<p>我们还创建了一个 <strong>vote()</strong> 函数的虚拟实现。让我们来创建一个真实的版本。 将下面的代码添加到 <strong>polls/views.py</strong>：</p>
<pre><code class="python"># polls/views.py

from django.shortcuts import get_object_or_404, render
from django.http import HttpResponseRedirect, HttpResponse
from django.core.urlresolvers import reverse

from .models import Choice, Question
# ...
def vote(request, question_id):
    p = get_object_or_404(Question, pk=question_id)
    try:
        selected_choice = p.choice_set.get(pk=request.POST['choice'])
    except (KeyError, Choice.DoesNotExist):
        # 重新显示问题的投票表单
        return render(request, 'polls/detail.html', {
            'question': p,
            'error_message': &quot;You didn't select a choice.&quot;,
        })
    else:
        selected_choice.votes += 1
        selected_choice.save()
        # 成功处理之后 POST 数据之后，总是返回一个 HttpResponseRedirect 。防止因为用户点击了后退按钮而提交了两次。
        return HttpResponseRedirect(reverse('polls:results', args=(p.id,)))
</code></pre>

<p>以上代码中有些内容还未在本教程中提到过：</p>
<ul>
<li>
<p><a href="https://docs.djangoproject.com/en/1.8/ref/request-response/#django.http.HttpRequest.POST"><strong>request.POST</strong></a> 是一个类字典对象，让你可以通过关键字的名字获取提交的数据。 这个例子中，<strong>request.POST['choice']</strong> 以字符串形式返回选择的 Choice 的 ID。<a href="https://docs.djangoproject.com/en/1.8/ref/request-response/#django.http.HttpRequest.POST"><strong>request.POST</strong></a> 的值永远是字符串。
注意，Django 还以同样的方式提供 <a href="https://docs.djangoproject.com/en/1.8/ref/request-response/#django.http.HttpRequest.GET"><strong>request.GET</strong></a> 用于访问 GET 数据 —— 但我们在代码中显式地使用 <a href="https://docs.djangoproject.com/en/1.8/ref/request-response/#django.http.HttpRequest.POST"><strong>request.POST</strong></a> ，以保证数据只能通过POST调用改动。</p>
</li>
<li>
<p>如果在 POST 数据中没有提供 <strong>choice</strong>，<strong>request.POST['choice']</strong> 将引发一个 <a href="https://docs.python.org/3/library/exceptions.html#KeyError"><strong>KeyError</strong></a>。上面的代码检查 <a href="https://docs.python.org/3/library/exceptions.html#KeyError"><strong>KeyError</strong></a>，如果没有给出 <strong>choice</strong> 将重新显示Question表单和一个错误信息。</p>
</li>
<li>
<p>在增加Choice的得票数之后，代码返回一个 <a href="https://docs.djangoproject.com/en/1.8/ref/request-response/#django.http.HttpResponseRedirect"><strong>HttpResponseRedirect</strong></a> 而不是常用的 <a href="https://docs.djangoproject.com/en/1.8/ref/request-response/#django.http.HttpResponse"><strong>HttpResponse</strong></a>。<a href="https://docs.djangoproject.com/en/1.8/ref/request-response/#django.http.HttpResponseRedirect"><strong>HttpResponseRedirect</strong></a> 只接收一个参数：用户将要被重定向的 URL（请继续看下去，我们将会解释如何构造这个例子中的 URL）。
正如上面的Python注释指出的，你应该在成功处理 POST 数据后总是返回一个 <a href="https://docs.djangoproject.com/en/1.8/ref/request-response/#django.http.HttpResponseRedirect"><strong>HttpResponseRedirect</strong></a>。 这不是 Django 的特定技巧；这是那些优秀网站在开发实践中形成的共识。</p>
</li>
<li>
<p>在这个例子中，我们在 <a href="https://docs.djangoproject.com/en/1.8/ref/request-response/#django.http.HttpResponseRedirect"><strong>HttpResponseRedirect</strong></a> 的构造函数中使用 <a href="https://docs.djangoproject.com/en/1.8/ref/urlresolvers/#django.core.urlresolvers.reverse"><strong>reverse()</strong></a> 函数。这个函数避免了我们在视图函数中硬编码 URL。它需要我们给出我们想要跳转的视图的名字和该视图所对应的URL模式中需要给该视图提供的参数。 在本例中，使用在<a href="../part3/">第三部分（zh）</a>中设定的URLconf， <a href="https://docs.djangoproject.com/en/1.8/ref/urlresolvers/#django.core.urlresolvers.reverse"><strong>reverse()</strong></a> 调用将返回一个这样的字符串：</p>
</li>
</ul>
<p><code>'/polls/3/results/'</code></p>
<p>... 其中3是 <strong>p.id</strong> 的值。重定向的 URL 将调用 <strong>'results'</strong> 视图来显示最终的页面。</p>
<p>​</p>
<p>正如在<a href="../part3/">第三部分（zh）</a>中提到的，<strong>request</strong> 是一个 <a href="https://docs.djangoproject.com/en/1.8/ref/request-response/#django.http.HttpRequest"><strong>HttpRequest</strong></a> 对象。更多关于 <a href="https://docs.djangoproject.com/en/1.8/ref/request-response/#django.http.HttpRequest"><strong>HttpRequest</strong></a> 对象的内容，请参见 <a href="https://docs.djangoproject.com/en/1.8/ref/request-response/"><em>请求和响应的文档</em></a>。</p>
<p>当有人对 Question 进行投票后，<strong>vote()</strong> 视图将请求重定向到 Question 的结果界面。让我们来编写这个视图：</p>
<pre><code class="python"># polls/views.py

from django.shortcuts import get_object_or_404, render

def results(request, question_id):
    question = get_object_or_404(Question, pk=question_id)
    return render(request, 'polls/results.html', {'question': question})
    from django.http import HttpResponse


def index(request):
    return HttpResponse(&quot;Hello, world. You're at the polls index.&quot;)
</code></pre>

<p>这和<a href="../part3/">第三部分（zh）</a>中的 <strong>detail()</strong> 视图几乎一模一样。唯一的不同是模板的名字。 我们将在稍后解决这个冗余问题。</p>
<p>现在，创建一个 polls/results.html 模板：</p>
<pre><code class="html">&lt;!--- polls/templates/polls/results.htm --&gt;

&lt;h1&gt;{{ question.question_text }}&lt;/h1&gt;

&lt;ul&gt;
{% for choice in question.choice_set.all %}
    &lt;li&gt;{{ choice.choice_text }} -- {{ choice.votes }} vote{{ choice.votes|pluralize }}&lt;/li&gt;
{% endfor %}
&lt;/ul&gt;

&lt;a href=&quot;{% url 'polls:detail' question.id %}&quot;&gt;Vote again?&lt;/a&gt;
</code></pre>

<p>现在，在你的浏览器中访问 <strong>/polls/1/</strong> 然后为 Question 投票。你应该看到一个投票结果页面，并且在你每次投票之后都会更新。 如果你提交时没有选择任何Choice，你应该看到错误信息。</p>
<h2 id="_2">使用通用视图：代码还是少点好</h2>
<p>detail()（在<a href="../part3/">第三部分（zh）</a>中）和 <strong>results()</strong> 视图都很简单 —— 并且，像上面提到的那样，存在冗余问题。用来显示一个议题列表的 <strong>index()</strong> 视图（也在<a href="../part3/">第三部分（zh）</a> 中）和它们类似。</p>
<p>这些视图反映基本的 Web 开发中的一个常见情况：根据 URL 中的参数从数据库中获取数据、载入模板文件然后返回渲染后的模板。 由于这种情况特别常见，Django 提供一种快捷方式，叫做“通用视图”系统。</p>
<p>通用视图将常见的模式抽象化，可以使你在编写应用时甚至不需要编写Python代码。</p>
<p>让我们将我们的投票应用转换成使用通用视图系统，这样我们可以删除许多我们的代码。我们仅仅需要做以下几步来完成转换： 我们将：</p>
<ol>
<li>转换 URLconf。</li>
<li>删除一些旧的、不再需要的代码。</li>
<li>引进基于 Django 通用视图的新视图。</li>
</ol>
<p>请继续阅读来了解详细信息。</p>
<blockquote>
<p><strong>为什么要重构代码？</strong></p>
<p>一般来说，当编写一个 Django 应用时，你应该先评估一下通用视图是否可以解决你的问题，你应该在一开始使用它，而不是进行到一半时重构代码。本教程目前为止是有意将重点放在以“艰难的方式”编写视图，这是为将重点放在核心概念上。</p>
<p>就像在使用计算器之前你需要知道基本的数学一样。</p>
</blockquote>
<h3 id="urlconf">改良 URLconf</h3>
<p>首先，打开 <strong>polls/urls.py</strong> 这个 URLconf 并将它修改成：</p>
<pre><code class="python"># polls/urls.py

from django.conf.urls import url

from . import views

urlpatterns = [
    url(r'^$', views.IndexView.as_view(), name='index'),
    url(r'^(?P&lt;pk&gt;[0-9]+)/$', views.DetailView.as_view(), name='detail'),
    url(r'^(?P&lt;pk&gt;[0-9]+)/results/$', views.ResultsView.as_view(), name='results'),
    url(r'^(?P&lt;question_id&gt;[0-9]+)/vote/$', views.vote, name='vote'),
]
</code></pre>

<p>注意在第二个和第三个模式的正则表达式中，匹配的模式的名字由 <strong>&lt;question_id&gt;</strong>  变成 <strong>&lt;pk&gt;</strong>。</p>
<h3 id="_3">改良视图</h3>
<p>下一步，我们将删除旧的 <strong>index、detail</strong>和 <strong>results</strong> 视图，并用 Django 的通用视图代替。打开 <strong>polls/views.py</strong> 文件，并将它修改成：</p>
<pre><code class="python"># polls/views.py

from django.shortcuts import get_object_or_404, render
from django.http import HttpResponseRedirect
from django.core.urlresolvers import reverse
from django.views import generic

from .models import Choice, Question


class IndexView(generic.ListView):
    template_name = 'polls/index.html'
    context_object_name = 'latest_question_list'

    def get_queryset(self):
        &quot;&quot;&quot;返回最后发布的5个问题&quot;&quot;&quot;
        return Question.objects.order_by('-pub_date')[:5]


class DetailView(generic.DetailView):
    model = Question
    template_name = 'polls/detail.html'


class ResultsView(generic.DetailView):
    model = Question
    template_name = 'polls/results.html'


def vote(request, question_id):
    ... # 像上面一样保存
</code></pre>

<p>我们在这里使用两个通用视图： <a href="https://docs.djangoproject.com/en/1.8/ref/class-based-views/generic-display/#django.views.generic.list.ListView"><strong>ListView</strong></a> 和 <a href="https://docs.djangoproject.com/en/1.8/ref/class-based-views/generic-display/#django.views.generic.detail.DetailView"><strong>DetailView</strong></a>。这两个视图分别抽象“显示一个对象列表”和“显示一个特定类型对象的详细信息页面”这两种概念。</p>
<ul>
<li>每个通用视图需要知道它将作用于哪个模型。 这由 <strong>model</strong> 属性提供。</li>
<li><a href="https://docs.djangoproject.com/en/1.8/ref/class-based-views/generic-display/#django.views.generic.detail.DetailView"><strong>DetailView</strong></a> 期望从 URL 中捕获名为 <strong>"pk"</strong> 的主键值，所以我们为通用视图把 <strong>question_id</strong> 改成 <strong>pk</strong> 。</li>
</ul>
<p>默认情况下，通用视图 <a href="https://docs.djangoproject.com/en/1.8/ref/class-based-views/generic-display/#django.views.generic.detail.DetailView"><strong>DetailView</strong></a> 使用一个叫做 <strong>"&lt;app name&gt;/&lt;model name&gt;_detail.html"</strong>的模板。在我们的例子中，它将使用 <strong>"polls/question_detail.html"</strong> 模板。<strong>template_name</strong>属性是用来告诉Django使用一个指定的模板名字，而不是自动生成的默认名字。 我们也为 <strong>results</strong> 列表视图指定了 <strong>template_name</strong> —— 这确保results视图和detail视图在渲染时具有不同的外观，即使它们在后台都是同一个 <a href="https://docs.djangoproject.com/en/1.8/ref/class-based-views/generic-display/#django.views.generic.detail.DetailView"><strong>DetailView</strong></a>。</p>
<p>类似地，<a href="https://docs.djangoproject.com/en/1.8/ref/class-based-views/generic-display/#django.views.generic.list.ListView"><strong>ListView</strong></a>使用一个叫做 <strong>"&lt;app name&gt;/&lt;model name&gt;_detail.html"</strong> 的默认模板；我们使用 <strong>template_name</strong> 来告诉 <a href="https://docs.djangoproject.com/en/1.8/ref/class-based-views/generic-display/#django.views.generic.list.ListView"><strong>ListView</strong></a> 使用我们自己已经存在的 <strong>"polls/index.html"</strong> 模板。</p>
<p>在之前的教程中，提供模板文件时都带有一个包含  <strong>question</strong> 和 <strong>latest_question_list</strong> 变量的 context。对于 <a href="https://docs.djangoproject.com/en/1.8/ref/class-based-views/generic-display/#django.views.generic.detail.DetailView"><strong>DetailView</strong></a> ， <strong>question</strong> 变量会自动提供—— 因为我们使用 Django 的模型 (<strong>Question)，</strong> Django 能够为context 变量决定一个合适的名字。然而对于ListView， 自动生成的context 变量是<strong>question_list</strong>。为了覆盖这个行为，我们提供 <strong>context_object_name</strong> 属性，表示我们想使用<strong>latest_question_list</strong>。作为一种替换方案，你可以改变你的模板来匹配新的 context 变量 —— 但它告诉 Django 使用你想使用的变量名更容易多了。</p>
<p>启动服务器，使用一下基于通用视图的新投票应用。</p>
<p>更多关于通用视图的详细信息，请查看<a href="https://docs.djangoproject.com/en/1.8/topics/class-based-views/">通用视图的文档</a>。</p>
<p>当你对你所写的表单和通用视图感到满意后，请阅读<a href="../part5/">教程的第5部分</a> 来了解如何测试我们的投票应用。</p></div>
        </div>

        <footer class="col-md-12">
            <hr>
            
            <center>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a>.</center>
        </footer>

        <script src="../js/jquery-1.10.2.min.js"></script>
        <script src="../js/bootstrap-3.0.3.min.js"></script>
        <script src="../js/highlight.pack.js"></script>
        <script src="../js/base.js"></script>
    </body>
</html>