
<!DOCTYPE html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
        <meta name="description" content="Django 官方教程中文版">
      
      
        <link rel="canonical" href="https://7sdream.github.io/django-intro-zh/part4/">
      
      
        <meta name="author" content="7sDream">
      
      
        <link rel="shortcut icon" href="../assets/images/favicon.png">
      
      <meta name="generator" content="mkdocs-0.16.3, mkdocs-material-1.8.1">
    
    
      
        <title>第一个 Django 项目 - 第四部分 - Django intro 中文版</title>
      
    
    
      <script src="../assets/javascripts/modernizr-1df76c4e58.js"></script>
    
    
      <link rel="stylesheet" href="../assets/stylesheets/application-bfecc7305d.css">
      
    
    
      
        
        
        
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
      <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    
    
    
  </head>
  
  
  
  
    <body>
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="drawer">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="search">
    <label class="md-overlay" data-md-component="overlay" for="drawer"></label>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <a href="https://7sdream.github.io/django-intro-zh/" title="Django intro 中文版" class="md-icon md-icon--home md-header-nav__button">
          </a>
        
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <span class="md-flex__ellipsis md-header-nav__title">
          
            
              
                <span class="md-header-nav__parent">
                  文档
                </span>
              
            
            第一个 Django 项目 - 第四部分
          
        </span>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="search"></label>
  <div class="md-search__inner">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" required placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query">
      <label class="md-icon md-search__icon" for="search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset">close</button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result" data-md-lang-search="" data-md-lang-tokenizer="[\s\-]+">
          <div class="md-search-result__meta" data-md-lang-result-none="No matching documents" data-md-lang-result-one="1 matching document" data-md-lang-result-other="# matching documents">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  


  <a href="https://github.com/7sDream/django-intro-zh" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      django-intro-zh
    </div>
  </a>

          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="drawer">
    
      <i class="md-icon md-icon--home md-nav__button"></i>
    
    Django intro 中文版
  </label>
  
    <div class="md-nav__source">
      


  


  <a href="https://github.com/7sDream/django-intro-zh" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      django-intro-zh
    </div>
  </a>

    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." title="介绍" class="md-nav__link">
      介绍
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2" checked>
    
    <label class="md-nav__link" for="nav-2">
      文档
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        文档
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../glance/" title="初识 Django" class="md-nav__link">
      初识 Django
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../install/" title="快速安装指南" class="md-nav__link">
      快速安装指南
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../part1/" title="第一个 Django 项目 - 第一部分" class="md-nav__link">
      第一个 Django 项目 - 第一部分
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../part2/" title="第一个 Django 项目 - 第二部分" class="md-nav__link">
      第一个 Django 项目 - 第二部分
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../part3/" title="第一个 Django 项目 - 第三部分" class="md-nav__link">
      第一个 Django 项目 - 第三部分
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="toc">
        第一个 Django 项目 - 第四部分
      </label>
    
    <a href="./" title="第一个 Django 项目 - 第四部分" class="md-nav__link md-nav__link--active">
      第一个 Django 项目 - 第四部分
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" title="编写一个简单的表单" class="md-nav__link">
    编写一个简单的表单
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_2" title="使用通用视图：代码还是少点好" class="md-nav__link">
    使用通用视图：代码还是少点好
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#urlconf" title="改良 URLconf" class="md-nav__link">
    改良 URLconf
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_3" title="改良视图" class="md-nav__link">
    改良视图
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../part5/" title="第一个 Django 项目 - 第五部分" class="md-nav__link">
      第一个 Django 项目 - 第五部分
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../part6/" title="第一个 Django 项目 - 第六部分" class="md-nav__link">
      第一个 Django 项目 - 第六部分
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../part7/" title="第一个 Django 项目 - 第七部分" class="md-nav__link">
      第一个 Django 项目 - 第七部分
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../whats_next/" title="下一步我该干什么" class="md-nav__link">
      下一步我该干什么
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../reusable_app/" title="编写可重用的应用" class="md-nav__link">
      编写可重用的应用
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../patch/" title="为 Django 贡献代码" class="md-nav__link">
      为 Django 贡献代码
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" title="编写一个简单的表单" class="md-nav__link">
    编写一个简单的表单
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_2" title="使用通用视图：代码还是少点好" class="md-nav__link">
    使用通用视图：代码还是少点好
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#urlconf" title="改良 URLconf" class="md-nav__link">
    改良 URLconf
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_3" title="改良视图" class="md-nav__link">
    改良视图
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="django">创建你的第一个 Django 项目， 第四部分</h1>
<p>这一篇从 <a href="../part3/">第三部分（zh）</a>结尾的地方继续讲起。我们将继续编写投票应用，本章着力于简单的表单处理和精简我们的代码。</p>
<h2 id="_1">编写一个简单的表单</h2>
<p>让我们更新一下在上一个教程中编写的投票详细页面的模板（“polls/detail.html”），让它包含一个 HTML  &lt;<strong>form</strong>&gt;元素：</p>
<div class="codehilite"><pre><span></span><span class="c">&lt;!--- polls/templates/polls/detail.html --&gt;</span>

<span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;</span>{{ question.question_text }}<span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>

{% if error_message %}<span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;&lt;</span><span class="nt">strong</span><span class="p">&gt;</span>{{ error_message }}<span class="p">&lt;/</span><span class="nt">strong</span><span class="p">&gt;&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>{% endif %}

<span class="p">&lt;</span><span class="nt">form</span> <span class="na">action</span><span class="o">=</span><span class="s">&quot;{% url &#39;polls:vote&#39; question.id %}&quot;</span> <span class="na">method</span><span class="o">=</span><span class="s">&quot;post&quot;</span><span class="p">&gt;</span>
{% csrf_token %}
{% for choice in question.choice_set.all %}
    <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;radio&quot;</span> <span class="na">name</span><span class="o">=</span><span class="s">&quot;choice&quot;</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;choice{{ forloop.counter }}&quot;</span> <span class="na">value</span><span class="o">=</span><span class="s">&quot;{{ choice.id }}&quot;</span> <span class="p">/&gt;</span>
    <span class="p">&lt;</span><span class="nt">label</span> <span class="na">for</span><span class="o">=</span><span class="s">&quot;choice{{ forloop.counter }}&quot;</span><span class="p">&gt;</span>{{ choice.choice_text }}<span class="p">&lt;/</span><span class="nt">label</span><span class="p">&gt;&lt;</span><span class="nt">br</span> <span class="p">/&gt;</span>
{% endfor %}
<span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;submit&quot;</span> <span class="na">value</span><span class="o">=</span><span class="s">&quot;Vote&quot;</span> <span class="p">/&gt;</span>
<span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
</pre></div>


<p>简要说明：</p>
<ul>
<li>上面的模板在 Question 的每个 Choice 前添加一个单选按钮。 每个单选按钮的 <strong>value</strong> 属性是对应的各个 Choice 的 ID。每个单选按钮的 <strong>name</strong> 是 <strong>"choice"</strong>。这意味着，当有人选择一个单选按钮并提交表单提交时，它将发送一个 POST 数据 choice=#，其中# 为选择的 Choice 的 ID。这是 HTML 表单的基本概念。</li>
<li>我们设置表单的 <strong>action</strong> 为 <strong>{% url 'polls:vote' question.id %}</strong>，并设置   <strong>method="post"</strong>。使用 <strong>method="post"</strong>（与其相对的是<strong>method="get"</strong>）是非常重要的，因为这个提交表单的行为会改变服务器端的数据。 无论何时，当你需要创建一个改变服务器端数据的表单时，请使用 <strong>method="post"</strong>。这不是 Django 的特定技巧；这是优秀的网站开发实践。</li>
<li><strong>forloop.counter</strong> 指示 <a href="https://docs.djangoproject.com/en/1.11/ref/templates/builtins/#std:templatetag-for"><strong>for</strong></a> 标签已经循环多少次。</li>
<li>由于我们创建一个 POST 表单（它具有修改数据的作用），所以我们需要小心跨站点请求伪造。 谢天谢地，你不必太过担心，因为 Django 已经拥有一个用来防御它的非常容易使用的系统。 简而言之，所有针对内部 URL 的 POST 表单都应该使用 <a href="https://docs.djangoproject.com/en/1.11/ref/templates/builtins/#std:templatetag-csrf_token"><strong>{% csrf_token %}</strong></a> 模板标签。</li>
</ul>
<p>现在，让我们来创建一个 Django 视图来处理提交的数据。记住，在教程 <a href="../part3/">第三部分（zh）</a>中，我们为投票应用创建了一个 URLconf ，包含这一行：</p>
<div class="codehilite"><pre><span></span><span class="c1"># polls/urls.py</span>

<span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^(?P&lt;question_id&gt;[0-9]+)/vote/$&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">vote</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;vote&#39;</span><span class="p">),</span>
</pre></div>


<p>我们还创建了一个 <strong>vote()</strong> 函数的虚拟实现。让我们来创建一个真实的版本。 将下面的代码添加到 <strong>polls/views.py</strong>：</p>
<div class="codehilite"><pre><span></span><span class="c1"># polls/views.py</span>

<span class="kn">from</span> <span class="nn">django.shortcuts</span> <span class="k">import</span> <span class="n">get_object_or_404</span><span class="p">,</span> <span class="n">render</span>
<span class="kn">from</span> <span class="nn">django.http</span> <span class="k">import</span> <span class="n">HttpResponseRedirect</span><span class="p">,</span> <span class="n">HttpResponse</span>
<span class="kn">from</span> <span class="nn">django.urls</span> <span class="k">import</span> <span class="n">reverse</span>

<span class="kn">from</span> <span class="nn">.models</span> <span class="k">import</span> <span class="n">Choice</span><span class="p">,</span> <span class="n">Question</span>
<span class="c1"># ...</span>
<span class="k">def</span> <span class="nf">vote</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">question_id</span><span class="p">):</span>
    <span class="n">question</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Question</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="n">question_id</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">selected_choice</span> <span class="o">=</span> <span class="n">question</span><span class="o">.</span><span class="n">choice_set</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">[</span><span class="s1">&#39;choice&#39;</span><span class="p">])</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="n">Choice</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">):</span>
        <span class="c1"># 重新显示问题的投票表单</span>
        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;polls/detail.html&#39;</span><span class="p">,</span> <span class="p">{</span>
            <span class="s1">&#39;question&#39;</span><span class="p">:</span> <span class="n">question</span><span class="p">,</span>
            <span class="s1">&#39;error_message&#39;</span><span class="p">:</span> <span class="s2">&quot;You didn&#39;t select a choice.&quot;</span><span class="p">,</span>
        <span class="p">})</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">selected_choice</span><span class="o">.</span><span class="n">votes</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">selected_choice</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="c1"># 成功处理之后 POST 数据之后，总是返回一个 HttpResponseRedirect 。防止因为用户点击了后退按钮而提交了两次。</span>
        <span class="k">return</span> <span class="n">HttpResponseRedirect</span><span class="p">(</span><span class="n">reverse</span><span class="p">(</span><span class="s1">&#39;polls:results&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">question</span><span class="o">.</span><span class="n">id</span><span class="p">,)))</span>
</pre></div>


<p>以上代码中有些内容还未在本教程中提到过：</p>
<ul>
<li>
<p><a href="https://docs.djangoproject.com/en/1.11/ref/request-response/#django.http.HttpRequest.POST"><strong>request.POST</strong></a> 是一个类字典对象，让你可以通过关键字的名字获取提交的数据。 这个例子中，<strong>request.POST['choice']</strong> 以字符串形式返回选择的 Choice 的 ID。<a href="https://docs.djangoproject.com/en/1.11/ref/request-response/#django.http.HttpRequest.POST"><strong>request.POST</strong></a> 的值永远是字符串。
注意，Django 还以同样的方式提供 <a href="https://docs.djangoproject.com/en/1.11/ref/request-response/#django.http.HttpRequest.GET"><strong>request.GET</strong></a> 用于访问 GET 数据 —— 但我们在代码中显式地使用 <a href="https://docs.djangoproject.com/en/1.11/ref/request-response/#django.http.HttpRequest.POST"><strong>request.POST</strong></a> ，以保证数据只能通过POST调用改动。</p>
</li>
<li>
<p>如果在 POST 数据中没有提供 <strong>choice</strong>，<strong>request.POST['choice']</strong> 将引发一个 <a href="https://docs.python.org/3/library/exceptions.html#KeyError"><strong>KeyError</strong></a>。上面的代码检查 <a href="https://docs.python.org/3/library/exceptions.html#KeyError"><strong>KeyError</strong></a>，如果没有给出 <strong>choice</strong> 将重新显示Question表单和一个错误信息。</p>
</li>
<li>
<p>在增加Choice的得票数之后，代码返回一个 <a href="https://docs.djangoproject.com/en/1.11/ref/request-response/#django.http.HttpResponseRedirect"><strong>HttpResponseRedirect</strong></a> 而不是常用的 <a href="https://docs.djangoproject.com/en/1.11/ref/request-response/#django.http.HttpResponse"><strong>HttpResponse</strong></a>。<a href="https://docs.djangoproject.com/en/1.11/ref/request-response/#django.http.HttpResponseRedirect"><strong>HttpResponseRedirect</strong></a> 只接收一个参数：用户将要被重定向的 URL（请继续看下去，我们将会解释如何构造这个例子中的 URL）。
正如上面的Python注释指出的，你应该在成功处理 POST 数据后总是返回一个 <a href="https://docs.djangoproject.com/en/1.11/ref/request-response/#django.http.HttpResponseRedirect"><strong>HttpResponseRedirect</strong></a>。 这不是 Django 的特定技巧；这是那些优秀网站在开发实践中形成的共识。</p>
</li>
<li>
<p>在这个例子中，我们在 <a href="https://docs.djangoproject.com/en/1.11/ref/request-response/#django.http.HttpResponseRedirect"><strong>HttpResponseRedirect</strong></a> 的构造函数中使用 <a href="https://docs.djangoproject.com/en/1.11/ref/urlresolvers/#django.urls.reverse"><strong>reverse()</strong></a> 函数。这个函数避免了我们在视图函数中硬编码 URL。它需要我们给出我们想要跳转的视图的名字和该视图所对应的URL模式中需要给该视图提供的参数。 在本例中，使用在 <a href="../part3/">第三部分（zh）</a>中设定的URLconf， <a href="https://docs.djangoproject.com/en/1.11/ref/urlresolvers/#django.urls.reverse"><strong>reverse()</strong></a> 调用将返回一个这样的字符串：</p>
</li>
</ul>
<p><code>'/polls/3/results/'</code></p>
<p>其中 <strong>3</strong> 是 <strong>question.id</strong> 的值。重定向的 URL 将调用 <strong>'results'</strong> 视图来显示最终的页面。</p>
<p>正如在 <a href="../part3/">第三部分（zh）</a>中提到的，<strong>request</strong> 是一个 <a href="https://docs.djangoproject.com/en/1.11/ref/request-response/#django.http.HttpRequest"><strong>HttpRequest</strong></a> 对象。更多关于 <a href="https://docs.djangoproject.com/en/1.11/ref/request-response/#django.http.HttpRequest"><strong>HttpRequest</strong></a> 对象的内容，请参见 <a href="https://docs.djangoproject.com/en/1.11/ref/request-response/"><em>请求和响应的文档</em></a>。</p>
<p>当有人对 Question 进行投票后，<strong>vote()</strong> 视图将请求重定向到 Question 的结果界面。让我们来编写这个视图：</p>
<div class="codehilite"><pre><span></span><span class="c1"># polls/views.py</span>

<span class="kn">from</span> <span class="nn">django.shortcuts</span> <span class="k">import</span> <span class="n">get_object_or_404</span><span class="p">,</span> <span class="n">render</span>

<span class="k">def</span> <span class="nf">results</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">question_id</span><span class="p">):</span>
    <span class="n">question</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Question</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="n">question_id</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;polls/results.html&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;question&#39;</span><span class="p">:</span> <span class="n">question</span><span class="p">})</span>
</pre></div>


<p>这和 <a href="../part3/">第三部分（zh）</a>中的 <strong>detail()</strong> 视图几乎一模一样。唯一的不同是模板的名字。 我们将在稍后解决这个冗余问题。</p>
<p>现在，创建一个 <strong>polls/results.html</strong> 模板：</p>
<div class="codehilite"><pre><span></span><span class="c">&lt;!--- polls/templates/polls/results.htm --&gt;</span>

<span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;</span>{{ question.question_text }}<span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>

<span class="p">&lt;</span><span class="nt">ul</span><span class="p">&gt;</span>
{% for choice in question.choice_set.all %}
    <span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;</span>{{ choice.choice_text }} -- {{ choice.votes }} vote{{ choice.votes|pluralize }}<span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
{% endfor %}
<span class="p">&lt;/</span><span class="nt">ul</span><span class="p">&gt;</span>

<span class="p">&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;{% url &#39;polls:detail&#39; question.id %}&quot;</span><span class="p">&gt;</span>Vote again?<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
</pre></div>


<p>现在，在你的浏览器中访问 <strong>/polls/1/</strong> 然后为 Question 投票。你应该看到一个投票结果页面，并且在你每次投票之后都会更新。 如果你提交时没有选择任何Choice，你应该看到错误信息。</p>
<blockquote>
<p><strong>注意</strong></p>
<p>我们的 <strong>vote()</strong> 视图代码有点小问题。它首先从数据库中得到 <strong>selected_choice</strong> 对象，然后计算新的票数（<strong>votes</strong>），最后把新的票数存回数据库中。但如果两个用户几乎在同一时间在我们的网站上投票就会出现错误：同票数，比如说 42 张票。然后两个用户计算和保存的票数都会是 43，而不是我们期待的 44。</p>
<p>这就是<em>竞争条件（race condition）</em>，如果你感兴趣，可以阅读 <a href="https://docs.djangoproject.com/en/1.11/ref/models/expressions/#avoiding-race-conditions-using-f">使用 F() 来避免竞争条件</a>，学一下如何解决这个问题。</p>
</blockquote>
<h2 id="_2">使用通用视图：代码还是少点好</h2>
<p><strong>detail()</strong>（在 <a href="../part3/">第三部分（zh）</a>中）和 <strong>results()</strong> 视图都很简单 —— 并且，像上面提到的那样，存在冗余问题。用来显示一个议题列表的 <strong>index()</strong> 视图（也在 <a href="../part3/">第三部分（zh）</a> 中）和它们类似。</p>
<p>这些视图反映基本的 Web 开发中的一个常见情况：根据 URL 中的参数从数据库中获取数据、载入模板文件然后返回渲染后的模板。 由于这种情况特别常见，Django 提供一种快捷方式，叫做“通用视图”系统。</p>
<p>通用视图将常见的模式抽象化，可以使你在编写应用时甚至不需要编写 Python 代码。</p>
<p>让我们将我们的投票应用转换成使用通用视图系统，这样我们可以删除许多我们的代码。我们仅仅需要做以下几步来完成转换： 我们将：</p>
<ol>
<li>转换 URLconf。</li>
<li>删除一些旧的、不再需要的代码。</li>
<li>引进基于 Django 通用视图的新视图。</li>
</ol>
<p>请继续阅读来了解详细信息。</p>
<blockquote>
<p><strong>为什么要重构代码？</strong></p>
<p>一般来说，当编写一个 Django 应用时，你应该先评估一下通用视图是否可以解决你的问题，你应该在一开始使用它，而不是进行到一半时重构代码。本教程目前为止是有意将重点放在以“艰难的方式”编写视图，这是为将重点放在核心概念上。</p>
<p>就像在使用计算器之前你需要知道基本的数学一样。</p>
</blockquote>
<h3 id="urlconf"><strong>改良 URLconf</strong></h3>
<p>首先，打开 <strong>polls/urls.py</strong> 这个 URLconf 并将它修改成：</p>
<div class="codehilite"><pre><span></span><span class="c1"># polls/urls.py</span>

<span class="kn">from</span> <span class="nn">django.conf.urls</span> <span class="k">import</span> <span class="n">url</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">views</span>

<span class="n">app_name</span> <span class="o">=</span> <span class="s1">&#39;polls&#39;</span>
<span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^$&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">IndexView</span><span class="o">.</span><span class="n">as_view</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">),</span>
    <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^(?P&lt;pk&gt;[0-9]+)/$&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">DetailView</span><span class="o">.</span><span class="n">as_view</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;detail&#39;</span><span class="p">),</span>
    <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^(?P&lt;pk&gt;[0-9]+)/results/$&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">ResultsView</span><span class="o">.</span><span class="n">as_view</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;results&#39;</span><span class="p">),</span>
    <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^(?P&lt;question_id&gt;[0-9]+)/vote/$&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">vote</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;vote&#39;</span><span class="p">),</span>
<span class="p">]</span>
</pre></div>


<p>注意在第二个和第三个模式的正则表达式中，匹配的模式的名字由 <strong>&lt;question_id&gt;</strong>  变成 <strong>&lt;pk&gt;</strong>。</p>
<h3 id="_3"><strong>改良视图</strong></h3>
<p>下一步，我们将删除旧的 <strong>index</strong>、 <strong>detail</strong> 和 <strong>results</strong> 视图，并用 Django 的通用视图代替。打开 <strong>polls/views.py</strong> 文件，并将它修改成：</p>
<div class="codehilite"><pre><span></span><span class="c1"># polls/views.py</span>

<span class="kn">from</span> <span class="nn">django.shortcuts</span> <span class="k">import</span> <span class="n">get_object_or_404</span><span class="p">,</span> <span class="n">render</span>
<span class="kn">from</span> <span class="nn">django.http</span> <span class="k">import</span> <span class="n">HttpResponseRedirect</span>
<span class="kn">from</span> <span class="nn">django.urls</span> <span class="k">import</span> <span class="n">reverse</span>
<span class="kn">from</span> <span class="nn">django.views</span> <span class="k">import</span> <span class="n">generic</span>

<span class="kn">from</span> <span class="nn">.models</span> <span class="k">import</span> <span class="n">Choice</span><span class="p">,</span> <span class="n">Question</span>


<span class="k">class</span> <span class="nc">IndexView</span><span class="p">(</span><span class="n">generic</span><span class="o">.</span><span class="n">ListView</span><span class="p">):</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s1">&#39;polls/index.html&#39;</span>
    <span class="n">context_object_name</span> <span class="o">=</span> <span class="s1">&#39;latest_question_list&#39;</span>

    <span class="k">def</span> <span class="nf">get_queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; 返回最近时间的五个问题 &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">Question</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s1">&#39;-pub_date&#39;</span><span class="p">)[:</span><span class="mi">5</span><span class="p">]</span>


<span class="k">class</span> <span class="nc">DetailView</span><span class="p">(</span><span class="n">generic</span><span class="o">.</span><span class="n">DetailView</span><span class="p">):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">Question</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s1">&#39;polls/detail.html&#39;</span>


<span class="k">class</span> <span class="nc">ResultsView</span><span class="p">(</span><span class="n">generic</span><span class="o">.</span><span class="n">DetailView</span><span class="p">):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">Question</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s1">&#39;polls/results.html&#39;</span>


<span class="k">def</span> <span class="nf">vote</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">question_id</span><span class="p">):</span>
    <span class="o">...</span> <span class="c1"># 像上面一样保存</span>
</pre></div>


<p>我们在这里使用两个通用视图： <a href="https://docs.djangoproject.com/en/1.11/ref/class-based-views/generic-display/#django.views.generic.list.ListView"><strong>ListView</strong></a> 和 <a href="https://docs.djangoproject.com/en/1.11/ref/class-based-views/generic-display/#django.views.generic.detail.DetailView"><strong>DetailView</strong></a>。这两个视图分别抽象“显示一个对象列表”和“显示一个特定类型对象的详细信息页面”这两种概念。</p>
<ul>
<li>每个通用视图需要知道它将作用于哪个模型。 这由 <strong>model</strong> 属性提供。</li>
<li><a href="https://docs.djangoproject.com/en/1.11/ref/class-based-views/generic-display/#django.views.generic.detail.DetailView"><strong>DetailView</strong></a> 期望从 URL 中捕获名为 <strong>"pk"</strong> 的主键值，所以我们为通用视图把 <strong>question_id</strong> 改成 <strong>pk</strong> 。</li>
</ul>
<p>默认情况下，通用视图 <a href="https://docs.djangoproject.com/en/1.11/ref/class-based-views/generic-display/#django.views.generic.detail.DetailView"><strong>DetailView</strong></a> 使用一个叫做 <strong>"&lt;app name&gt;/&lt;model name&gt;_detail.html"</strong> 的模板。在我们的例子中，它将使用 <strong>"polls/question_detail.html"</strong> 模板。<strong>template_name</strong> 属性是用来告诉Django使用一个指定的模板名字，而不是自动生成的默认名字。 我们也为 <strong>results</strong> 列表视图指定了 <strong>template_name</strong> —— 这确保results视图和detail视图在渲染时具有不同的外观，即使它们在后台都是同一个 <a href="https://docs.djangoproject.com/en/1.11/ref/class-based-views/generic-display/#django.views.generic.detail.DetailView"><strong>DetailView</strong></a>。</p>
<p>类似地，<a href="https://docs.djangoproject.com/en/1.11/ref/class-based-views/generic-display/#django.views.generic.list.ListView"><strong>ListView</strong></a> 使用一个叫做 <strong>"&lt;app name&gt;/&lt;model name&gt;_detail.html"</strong> 的默认模板；我们使用 <strong>template_name</strong> 来告诉 <a href="https://docs.djangoproject.com/en/1.11/ref/class-based-views/generic-display/#django.views.generic.list.ListView"><strong>ListView</strong></a> 使用已经存在的 <strong>"polls/index.html"</strong> 模板。</p>
<p>在之前的教程中，提供模板文件时都带有一个包含  <strong>question</strong> 和 <strong>latest_question_list</strong> 变量的 context。对于 <a href="https://docs.djangoproject.com/en/1.11/ref/class-based-views/generic-display/#django.views.generic.detail.DetailView"><strong>DetailView</strong></a>， <strong>question</strong> 变量会自动提供—— 因为我们使用 Django 的模型 (<strong>Question</strong>)， Django 能够为context 变量决定一个合适的名字。然而对于 ListView， 自动生成的context 变量是 <strong>question_list</strong>。为了覆盖这个行为，我们提供 <strong>context_object_name</strong> 属性，表示我们想使用 <strong>latest_question_list</strong>。作为一种替换方案，你可以改变你的模板来匹配新的 context 变量 —— 但它告诉 Django 使用你想使用的变量名更容易多了。</p>
<p>启动服务器，使用一下基于通用视图的新投票应用。</p>
<p>更多关于通用视图的详细信息，请查看 <a href="https://docs.djangoproject.com/en/1.11/topics/class-based-views/">通用视图的文档</a>。</p>
<p>当你明白了这些表单和通用视图后，可以继续阅读 <a href="../part5/">教程第五部分（zh）</a> 来了解如何测试我们的投票应用。</p>
                
                  
                
              
              
                
              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../part3/" title="第一个 Django 项目 - 第三部分" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                第一个 Django 项目 - 第三部分
              </span>
            </div>
          </a>
        
        
          <a href="../part5/" title="第一个 Django 项目 - 第五部分" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                第一个 Django 项目 - 第五部分
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="http://www.mkdocs.org" title="MkDocs">MkDocs</a>
        and
        <a href="http://squidfunk.github.io/mkdocs-material/" title="Material for MkDocs">
          Material for MkDocs</a>
      </div>
      
        
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/application-6940329b9f.js"></script>
      
      
      <script>app.initialize({url:{base:".."}})</script>
      
    
    
      
    
  </body>
</html>